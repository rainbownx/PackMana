#!/bin/bash

REPO_DIR="./packages"
CACHE_DIR="./cache"
REPO_LIST="./repos.list"
CONFIG="$HOME/.packmana_config"      # Changed from ./ to $HOME for reliability
INSTALL_DIR="./installed"

mkdir -p "$REPO_DIR" "$CACHE_DIR" "$INSTALL_DIR"
touch "$REPO_LIST"

first_run_setup() {
    echo "Welcome to Packmana!"
    echo "It looks like this is your first time running Packmana."

    echo ""
    echo "Please select which package repositories you'd like to add:"
    echo "1) Packmana Official Repo"
    echo "   https://rainbownx.github.io/PackMana-Respository"
    echo "2) Arch Linux Official Repo"
    echo "   https://gitlab.archlinux.org/archlinux"
    echo "3) Arch User Repository (AUR) (Unofficial)"
    echo "   https://aur.archlinux.org"
    echo "4) None / Add your own repo URL"

    read -rp "Enter numbers separated by commas (e.g. 1,3): " choices

    add_repo_safe() {
        local url="$1"
        if grep -Fxq "$url" "$REPO_LIST" 2>/dev/null; then
            echo "Repo already added: $url"
        else
            echo "$url" >> "$REPO_LIST"
            echo "Added repo: $url"
        fi
    }

    IFS=',' read -ra sel <<< "$choices"
    for choice in "${sel[@]}"; do
        case "$choice" in
            1)
                add_repo_safe "https://rainbownx.github.io/PackMana-Respository"
                ;;
            2)
                add_repo_safe "https://gitlab.archlinux.org/archlinux"
                ;;
            3)
                add_repo_safe "https://aur.archlinux.org"
                ;;
            4)
                echo "You chose to add your own repo URL."
                ;;
            *)
                echo "Ignoring invalid choice: $choice"
                ;;
        esac
    done

    read -rp "Do you want to add a custom repository URL? (y/N): " addcustom
    if [[ "$addcustom" =~ ^[Yy]$ ]]; then
        while true; do
            read -rp "Enter the full URL of your custom repo (or leave empty to finish): " customurl
            if [[ -z "$customurl" ]]; then
                break
            fi
            add_repo_safe "$customurl"
        done
    fi

    touch "$CONFIG"  # Create the config file here so first run won't repeat
    echo "Setup complete! You can add more repos anytime with 'packmana add-repo <url>'."
    echo ""
}

# --- rest of your functions here ---

# ...

# Check first run by existence of config file in home directory
if [ ! -f "$CONFIG" ]; then
    first_run_setup
fi

# Your case/switch handling of commands follows...
case "$1" in
    install)
        if [ -z "$2" ]; then
            echo "Error: Please specify a package to install."
            exit 1
        fi
        install_pkg "$2"
        ;;
    remove)
        if [ -z "$2" ]; then
            echo "Error: Please specify a package to remove."
            exit 1
        fi
        remove_pkg "$2"
        ;;
    list)
        list_pkgs
        ;;
    search)
        search_pkgs
        ;;
    add-repo)
        if [ -z "$2" ]; then
            echo "Error: Please specify a repository URL to add."
            exit 1
        fi
        add_repo "$2"
        ;;
    list-repos)
        list_repos
        ;;
    repo-add)
        repo_add
        ;;
    update)
        update_pkgs
        ;;
    *)
        usage
        exit 1
        ;;
esac
